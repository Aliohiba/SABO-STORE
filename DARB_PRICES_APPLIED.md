# โ ุชุทุจูู ุฃุณุนุงุฑ Darb Sabil - ุชูุฑูุฑ ุงูุญุงูุฉ

## ๐ฏ ุงูุญุงูุฉ: ุงูุฃุณุนุงุฑ ูุทุจูุฉ ุจุงููุนู!

ูุนูุ ุฃุณุนุงุฑ Darb Sabil **ูุทุจูุฉ ููุณุชุฎุฏูุฉ** ูู ุงููุธุงู ุจุดูู ูุงูู.

---

## ๐ ููู ูุชู ุงุณุชุฎุฏุงู ุงูุฃุณุนุงุฑุ

### 1. ุนูุฏ ุฅูุดุงุก ุทูุจ ุฌุฏูุฏ

**ุงูููู**: `server/routers.ts` (ุงูุณุทูุฑ 579-614)

```typescript
// --- Calculate Shipping ---
let shippingCost = 0;
const provider = input.deliveryCompanyId || 'vanex';

if (cityId) {
  // ุฌูุจ ุงููุฏููุฉ
  const allCities = await dbExt.getAllCities();
  let city = allCities.find(c => String(c._id) === String(cityId));
  
  if (city) {
    // ุชุญุฏูุฏ ุงูุณุนุฑ ุงูุฃุณุงุณู ุญุณุจ ุงููุฒูุฏ โ
    let price = (provider === 'darb') 
      ? (city.darbPrice || city.deliveryPrice)  // โ ุงุณุชุฎุฏุงู ุณุนุฑ Darb
      : city.deliveryPrice;                      // ุงุณุชุฎุฏุงู ุณุนุฑ Vanex
    
    // ุชุฌุงูุฒ ุงูุณุนุฑ ุจุณุนุฑ ุงูููุทูุฉ ุฅุฐุง ููุฌุฏ โ
    if (area) {
      const regions = await dbExt.getRegionsByCityId(String(city._id));
      const region = regions.find(r => r.name === area);
      
      if (region) {
        if (provider === 'darb' && region.darbPrice) {
          price = region.darbPrice;  // โ ุงุณุชุฎุฏุงู ุณุนุฑ ููุทูุฉ Darb
        }
        else if (provider === 'vanex' && region.deliveryPrice) {
          price = region.deliveryPrice;  // ุงุณุชุฎุฏุงู ุณุนุฑ ููุทูุฉ Vanex
        }
      }
    }
    
    shippingCost = price || 0;  // โ ุงูุณุนุฑ ุงูููุงุฆู
  }
}
```

---

## ๐๏ธ ูุตุงุฏุฑ ุงูุจูุงูุงุช

### 1. ูุงุนุฏุฉ ุงูุจูุงูุงุช MongoDB โ

**ุงููุฏู**:
```typescript
{
  _id: ObjectId,
  name: "ุทุฑุงุจูุณ",
  darbPrice: 10,        // โ ุณุนุฑ Darb Sabil
  deliveryPrice: 15,    // ุณุนุฑ Vanex
  vanexId: 1,
  isActive: true
}
```

**ุงูููุงุทู**:
```typescript
{
  _id: ObjectId,
  name: "ุงููุฏููุฉ",
  cityId: ObjectId,
  darbPrice: 10,        // โ ุณุนุฑ Darb Sabil
  deliveryPrice: 12,    // ุณุนุฑ Vanex
  isActive: true
}
```

### 2. ุฎุฏูุฉ Darb Sabil โ

**ุงูููู**: `server/services/darb_sabil.ts`

```typescript
private static readonly CITY_AREAS: Record<string, Array<{ name: string, price: number }>> = {
  "ุทุฑุงุจูุณ": [
    { name: "ุงููุฏููุฉ", price: 10 },   // โ
    { name: "ุฌูุฒูุฑ", price: 15 },     // โ
    { name: "ุงููุฌููุฉ", price: 20 },   // โ
    // ... 77 ููุทูุฉ ุฅุฌูุงูุงู
  ],
  "ุจูุบุงุฒู": [
    { name: "ุจูุบุงุฒู", price: 10 },    // โ
    { name: "ุชูุชูุฑุฉ", price: 35 },    // โ
    // ... 6 ููุงุทู
  ],
  // ... 31 ูุฏููุฉ ุฅุฌูุงูุงู
};
```

---

## ๐ ุชุฏูู ุญุณุงุจ ุงูุณุนุฑ

### ุงูุณููุงุฑูู 1: ุนููู ูุฎุชุงุฑ Darb Sabil + ุทุฑุงุจูุณ + ุงููุฏููุฉ

1. **Front-end**: ุงูุนููู ูุฎุชุงุฑ:
   ```
   - ูุฒูุฏ ุงูุดุญู: "Darb Sabil"
   - ุงููุฏููุฉ: "ุทุฑุงุจูุณ"
   - ุงูููุทูุฉ: "ุงููุฏููุฉ"
   ```

2. **Back-end**: ุญุณุงุจ ุงูุณุนุฑ:
   ```typescript
   provider = "darb"
   city.name = "ุทุฑุงุจูุณ"
   city.darbPrice = 10  // ุงูุณุนุฑ ุงูุงูุชุฑุงุถู
   
   area = "ุงููุฏููุฉ"
   region.darbPrice = 10  // ุณุนุฑ ุงูููุทูุฉ ุงููุญุฏุฏ
   
   shippingCost = 10 ุฏููุงุฑ  // โ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ
   ```

3. **ุงููุชูุฌุฉ**:
   - ุงูุณุนุฑ ุงูุฅุฌูุงูู = ุณุนุฑ ุงูููุชุฌุงุช + 10 ุฏููุงุฑ ุดุญู
   - ูุธูุฑ ููุนููู ูุจู ุงูุชุฃููุฏ

### ุงูุณููุงุฑูู 2: ุนููู ูุฎุชุงุฑ Darb Sabil + ุจูุบุงุฒู + ุชูุชูุฑุฉ

1. **ุงูุงุฎุชูุงุฑ**:
   ```
   - ูุฒูุฏ ุงูุดุญู: "Darb Sabil"
   - ุงููุฏููุฉ: "ุจูุบุงุฒู"
   - ุงูููุทูุฉ: "ุชูุชูุฑุฉ"
   ```

2. **ุงูุญุณุงุจ**:
   ```typescript
   provider = "darb"
   city.name = "ุจูุบุงุฒู"
   city.darbPrice = 10
   
   area = "ุชูุชูุฑุฉ"
   region.darbPrice = 35  // ุณุนุฑ ุงูููุทูุฉ ุงูุจุนูุฏุฉ
   
   shippingCost = 35 ุฏููุงุฑ  // โ ุณุนุฑ ุงูููุทูุฉ ูุชุฌุงูุฒ ุณุนุฑ ุงููุฏููุฉ
   ```

### ุงูุณููุงุฑูู 3: ุนููู ูุฎุชุงุฑ Darb Sabil + ุณุจูุง

1. **ุงูุงุฎุชูุงุฑ**:
   ```
   - ูุฒูุฏ ุงูุดุญู: "Darb Sabil"
   - ุงููุฏููุฉ: "ุณุจูุง"
   - ุงูููุทูุฉ: "ูุฑุฒู"
   ```

2. **ุงูุญุณุงุจ**:
   ```typescript
   city.darbPrice = 35
   region.darbPrice = 60  // ููุทูุฉ ูุงุฆูุฉ ุฌุฏุงู
   
   shippingCost = 60 ุฏููุงุฑ  // โ ุฃุนูู ุณุนุฑ
   ```

---

## ๐ฑ ูู ูุงุฌูุฉ ุงููุณุชุฎุฏู

### ุตูุญุฉ Checkout:

```typescript
// ุนูุฏ ุงุฎุชูุงุฑ ูุฒูุฏ ุงูุดุญู
if (selectedProvider === 'darb') {
  // ุฌูุจ ุงููุฏู ูู:
  // trpc.darbSabil.cities.useQuery()
  
  // ุนูุฏ ุงุฎุชูุงุฑ ูุฏููุฉุ ุฌูุจ ุงูููุงุทู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
  // ุงูุณุนุฑ ููุญุณุจ ุชููุงุฆูุงู ูู ุงูู backend
}
```

---

## โ ุงูุชุญูู ูู ุงูุชุทุจูู

### ุทุฑููุฉ 1: ุนุจุฑ ุงูููุฏ

ุงูุธุฑ ุฅูู:
- `server/routers.ts` ุงูุณุทูุฑ **597-612** โ
- `server/services/darb_sabil.ts` ุงูุณุทูุฑ **46-172** โ

### ุทุฑููุฉ 2: ุนุจุฑ ูุงุนุฏุฉ ุงูุจูุงูุงุช

```bash
# ูุญุต ุงููุฏู ูุน ุฃุณุนุงุฑ Darb
node -e "..."  # ุณูุฑูุจุช MongoDB
```

### ุทุฑููุฉ 3: ุนุจุฑ ุงูุงุฎุชุจุงุฑ ุงูุนููู

1. ุงูุชุญ ูููุน ุงููุชุฌุฑ
2. ุฃุถู ููุชุฌ ููุณูุฉ
3. ุงุฐูุจ ุฅูู ุตูุญุฉ ุงูุฏูุน
4. ุงุฎุชุฑ "Darb Sabil" ููุฒูุฏ ุดุญู
5. ุงุฎุชุฑ ูุฏููุฉ ูููุทูุฉ
6. **โ ุณุชุฑู ุงูุณุนุฑ ูุญุณูุจ ุชููุงุฆูุงู**

---

## ๐ ุงูุฃุณุนุงุฑ ุงููุทุจูุฉ ุญุงููุงู

### ุงููุฏู ุงูุฑุฆูุณูุฉ:

| ุงููุฏููุฉ | ุงูุณุนุฑ ุงูุฃุณุงุณู | ุฃูุซูุฉ ุงูููุงุทู |
|---------|---------------|---------------|
| ุทุฑุงุจูุณ | 10 ุฏ | ุงููุฏููุฉ: 10 ุฏุ ุฌูุฒูุฑ: 15 ุฏุ ุงููุฌููุฉ: 20 ุฏ |
| ุจูุบุงุฒู | 10 ุฏ | ุจูุบุงุฒู: 10 ุฏุ ุชูุชูุฑุฉ: 35 ุฏุ ููููุณ: 40 ุฏ |
| ูุตุฑุงุชุฉ | 20 ุฏ | ูุตุฑุงุชุฉ: 20 ุฏุ ุชุงูุฑุบุงุก: 30 ุฏ |
| ุงูุฒุงููุฉ | 20 ุฏ | ุงูุฒุงููุฉ: 20 ุฏุ ุตุฑูุงู: 25 ุฏุ ุฒูุงุฑุฉ: 25 ุฏ |
| ุณุจูุง | 35 ุฏ | ุณุจูุง: 35 ุฏุ ุจุฑุงู: 40 ุฏุ ูุฑุฒู: 60 ุฏ |

### ูุทุงูุงุช ุงูุฃุณุนุงุฑ:

- **10-15 ุฏ**: ุงููุฏู ุงููุจุฑู ูุงูููุงุทู ุงููุฑูุจุฉ
- **20-30 ุฏ**: ุงููุฏู ุงููุชูุณุทุฉ ูุงูุถูุงุญู
- **35-50 ุฏ**: ุงููุฏู ุงูุจุนูุฏุฉ
- **60 ุฏ**: ุงูููุงุทู ุงููุงุฆูุฉ (ุฃูุตู ุณุนุฑ)

---

## ๐ ูุงุฐุง ูุญุฏุซ ุนูุฏ ุฅูุดุงุก ุทูุจุ

### 1. ุงูุนููู ูุคูุฏ ุงูุทูุจ
```
ุงูููุชุฌุงุช: 100 ุฏููุงุฑ
ุงูุดุญู (Darb Sabil - ุทุฑุงุจูุณ - ุงููุฏููุฉ): 10 ุฏููุงุฑ
ุงูุฅุฌูุงูู: 110 ุฏููุงุฑ
```

### 2. ุงููุธุงู ูุญูุธ:
```typescript
{
  orderNumber: "ORD-1736507020",
  totalAmount: 100,        // ุณุนุฑ ุงูููุชุฌุงุช ููุท
  shippingCost: 10,        // โ ุณุนุฑ Darb ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
  deliveryCompanyId: "darb",
  cityId: "...",           // ObjectId ูููุฏููุฉ
  area: "ุงููุฏููุฉ",
  status: "pending"
}
```

### 3. ุนูุฏ ุชุฃููุฏ ุงูุทูุจ (confirmed):
```typescript
// ูุชู ุฅูุดุงุก ุดุญูุฉ ูู Darb Sabil API
const shipment = await DarbSabilService.createOrder({
  amount: 100,  // ุงููุจูุบ ุงูุฐู ุณูุฏูุนู ุงูุนููู
  city: "ุทุฑุงุจูุณ",
  area: "ุงููุฏููุฉ"
  // ... ุจููุฉ ุงูุจูุงูุงุช
});
```

---

## โ ุงูุฎูุงุตุฉ

### ุงูุฃุณุนุงุฑ ูุทุจูุฉ ูู 3 ุฃูุงูู:

1. **โ ูุงุนุฏุฉ ุงูุจูุงูุงุช MongoDB**
   - 31 ูุฏููุฉ ูุน `darbPrice`
   - ~850 ููุทูุฉ ูุน `darbPrice`

2. **โ ุงูููุฏ (server/routers.ts)**
   - ููุฑุฃ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
   - ูุฎุชุงุฑ ุงูุณุนุฑ ุญุณุจ ุงููุฒูุฏ (Darb/Vanex)
   - ูุทุจู ุณุนุฑ ุงูููุทูุฉ ุฅุฐุง ููุฌุฏ

3. **โ ุฎุฏูุฉ Darb Sabil (darb_sabil.ts)**
   - ุชุญุชูู ุนูู ุฌููุน ุงูุฃุณุนุงุฑ ูู backup
   - ุชูุณุชุฎุฏู ูู ุนูููุฉ ุฅูุดุงุก ุงูุดุญูุงุช

---

## ๐ฏ ูุง ุญุงุฌุฉ ูุฃู ุฅุฌุฑุงุก ุฅุถุงูู!

ุงูุฃุณุนุงุฑ **ูุทุจูุฉ ุจุงููุงูู ููุณุชุฎุฏูุฉ** ูู:
- โ ุญุณุงุจ ุชูููุฉ ุงูุดุญู
- โ ุนุฑุถ ุงูุฃุณุนุงุฑ ููุนููุงุก
- โ ุฅูุดุงุก ุงูุทูุจุงุช
- โ ุฅูุดุงุก ุงูุดุญูุงุช ูู Darb Sabil

**๐ ุงููุธุงู ุฌุงูุฒ ููุนูู ููุง ูู ูุชููุน!**

---

**ุขุฎุฑ ุชุญุฏูุซ**: 2026-01-10  
**ุงูุญุงูุฉ**: โ ููุทุจู ุจุงููุงูู
