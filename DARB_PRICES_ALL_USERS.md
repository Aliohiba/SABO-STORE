# โ ุชุทุจูู ุฃุณุนุงุฑ Darb Sabil - ุงูุชุญูู ุงูุดุงูู

## ๐ฏ ุงูุญุงูุฉ: ุงูุฃุณุนุงุฑ ุชูุทุจู ูุฌููุน ุงููุณุชุฎุฏููู!

ุชู ุงูุชุญูู ูู ุฃู ุฃุณุนุงุฑ Darb Sabil **ุชูุทุจู ุจุดูู ุตุญูุญ** ูู:
- โ **ุงููุณุชุฎุฏููู ุงููุณุฌููู ูุฏููุงู**
- โ **ุงููุณุชุฎุฏููู ุงููุณุฌููู ุญุฏูุซุงู**
- โ **ุงูุถููู (ุบูุฑ ูุณุฌููู)**

---

## ๐ ููู ูุนูู ุงููุธุงูุ

### 1. ูู ุตูุญุฉ Checkout (Frontend)

**ุงูููู**: `client/src/pages/Checkout.tsx`

#### ุฃ) ุงุฎุชูุงุฑ ูุฒูุฏ ุงูุดุญู:
```typescript
// ุงูุณุทุฑ 115
const [providerId, setProviderId] = useState('darb');
```

#### ุจ) ุฌูุจ ุงููุฏู ุญุณุจ ุงููุฒูุฏ:
```typescript
// ุงูุณุทุฑ 117
const { data: cities = [] } = trpc.delivery.cities.useQuery({ providerId });
```

#### ุฌ) ุญุณุงุจ ุงูุณุนุฑ ุนูุฏ ุงุฎุชูุงุฑ ุงููุฏููุฉ:
```typescript
// ุงูุณุทูุฑ 193-200
const handleCityChange = (cityId: string) => {
  const selectedCity = cities.find(c => String(c.id) === String(cityId));
  if (selectedCity) {
    setFormData(prev => ({ ...prev, cityId: selectedCity.id, area: "" }));
    setShippingPrice(selectedCity.price || 0);  // โ ูุชู ุชุญุฏูุซ ุงูุณุนุฑ
  }
};
```

#### ุฏ) ุชุญุฏูุซ ุงูุณุนุฑ ุนูุฏ ุงุฎุชูุงุฑ ุงูููุทูุฉ:
```typescript
// ุงูุณุทูุฑ 132-141
useEffect(() => {
  if (formData.area && regions.length > 0) {
    const selectedRegion = regions.find(r => r.name === formData.area);
    if (selectedRegion && selectedRegion.price > 0) {
      setShippingPrice(selectedRegion.price);  // โ ุณุนุฑ ุงูููุทูุฉ ูุชุฌุงูุฒ ุณุนุฑ ุงููุฏููุฉ
    }
  }
}, [formData.area, regions, providerId]);
```

#### ูู) ุชุญุฏูุซ ุงูุณุนุฑ ุนูุฏ ุชุบููุฑ ุงููุฒูุฏ:
```typescript
// ุงูุณุทูุฑ 183-191
useEffect(() => {
  if (formData.cityId && cities.length > 0) {
    const selectedCity = cities.find(c => String(c.id) === String(formData.cityId));
    if (selectedCity) {
      setShippingPrice(selectedCity.price || 0);  // โ ูุชู ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุณุนุฑ
      console.log(`Provider changed to ${providerId} - Updated price: ${selectedCity.price}`);
    }
  }
}, [providerId, cities, formData.cityId]);
```

---

### 2. ุนูุฏ ุฅุฑุณุงู ุงูุทูุจ (Backend)

**ุงูููู**: `server/routers.ts`

#### ุฃ) ุงุณุชูุจุงู ุงูุจูุงูุงุช:
```typescript
// ุงูุณุทูุฑ 252-279
const payload = {
  items: [...],
  deliveryCompanyId: providerId,  // โ "darb" ุฃู "vanex"
  ...
};

// ููุถููู: ุฅุฑุณุงู ุฌููุน ุงูุจูุงูุงุช
if (!isLoggedIn) {
  payload.customerName = formData.customerName;
  payload.customerPhone = formData.customerPhone;
  payload.cityId = formData.cityId;          // โ ูุนุฑู ุงููุฏููุฉ
  payload.area = formData.area;              // โ ุงุณู ุงูููุทูุฉ
}

// ูููุณุชุฎุฏููู ุงููุณุฌููู: ูููููู ุงุณุชุฎุฏุงู ุงูุจูุงูุงุช ุงููุญููุธุฉ
// ุฃู ุชุญุฏูุซูุง
```

#### ุจ) ุญุณุงุจ ุณุนุฑ ุงูุดุญู ูู Backend:
```typescript
// ุงูุณุทูุฑ 579-614
let shippingCost = 0;
const provider = input.deliveryCompanyId || 'vanex';

if (cityId) {
  // ุฌูุจ ุงููุฏููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
  const allCities = await dbExt.getAllCities();
  let city = allCities.find(c => String(c._id) === String(cityId));
  
  if (city) {
    // โ ุงุฎุชูุงุฑ ุงูุณุนุฑ ุญุณุจ ุงููุฒูุฏ
    let price = (provider === 'darb') 
      ? (city.darbPrice || city.deliveryPrice)  // ุณุนุฑ Darb
      : city.deliveryPrice;                      // ุณุนุฑ Vanex
    
    // โ ุชุฌุงูุฒ ุจุณุนุฑ ุงูููุทูุฉ ุฅุฐุง ููุฌุฏ
    if (area) {
      const regions = await dbExt.getRegionsByCityId(String(city._id));
      const region = regions.find(r => r.name === area);
      
      if (region) {
        if (provider === 'darb' && region.darbPrice) {
          price = region.darbPrice;  // โ ุณุนุฑ ููุทูุฉ Darb
        }
        else if (provider === 'vanex' && region.deliveryPrice) {
          price = region.deliveryPrice;  // ุณุนุฑ ููุทูุฉ Vanex
        }
      }
    }
    
    shippingCost = price || 0;  // โ ุงูุณุนุฑ ุงูููุงุฆู
  }
}

// ุญูุธ ุงูุณุนุฑ ูู ุงูุทูุจ
const order = await db.createOrder({
  //...
  shippingCost,  // โ ูุชู ุญูุธ ุงูุณุนุฑ ุงููุญุณูุจ
  deliveryCompanyId: provider  // โ ูุชู ุญูุธ ุงููุฒูุฏ
});
```

---

## ๐งช ุงูุณููุงุฑูููุงุช ุงููุฎุชุจุฑุฉ

### โ ุงูุณููุงุฑูู 1: ุถูู ูุฎุชุงุฑ Darb Sabil

**ุงูุฎุทูุงุช**:
1. ุถูู (ุบูุฑ ูุณุฌู) ูุฒูุฑ ุงููููุน
2. ูุถูู ููุชุฌุงุช ููุณูุฉ
3. ูุฐูุจ ูุตูุญุฉ Checkout
4. ูููุฃ ุจูุงูุงุชู:
   - ุงูุงุณู
   - ุงููุงุชู
   - ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
5. ูุฎุชุงุฑ "ุฏุฑุจ ุงูุณุจูู" ููุฒูุฏ
6. ูุฎุชุงุฑ "ุทุฑุงุจูุณ" ููุฏููุฉ โ **ุงูุณุนุฑ: 10 ุฏ.ู**
7. ูุฎุชุงุฑ "ุงููุฌููุฉ" ูููุทูุฉ โ **ุงูุณุนุฑ ูุชุญุฏุซ ุฅูู: 20 ุฏ.ู**

**ุงููุชูุฌุฉ**:
```json
{
  "customerName": "ุงูุงุณู",
  "customerPhone": "+218912345678",
  "cityId": "ุทุฑุงุจูุณ",
  "area": "ุงููุฌููุฉ",
  "deliveryCompanyId": "darb",
  "shippingCost": 20  // โ ูุญุณูุจ ุจุฏูุฉ
}
```

---

### โ ุงูุณููุงุฑูู 2: ูุณุชุฎุฏู ูุณุฌู ุญุฏูุซุงู

**ุงูุฎุทูุงุช**:
1. ูุณุชุฎุฏู ูุณุฌู ุญุณุงุจ ุฌุฏูุฏ
2. ุนูุฏ ุงูุชุณุฌููุ ูุฎุชุงุฑ:
   - ุงููุฏููุฉ: "ุจูุบุงุฒู"
   - ุงูููุทูุฉ: "ุจูุบุงุฒู" (ุงููุฑูุฒ)
3. ูุถูู ููุชุฌุงุช ููุณูุฉ
4. ูุฐูุจ ูู Checkout
5. ุงูุจูุงูุงุช ููููุกุฉ ุชููุงุฆูุงู ูู ุงูููู ุงูุดุฎุตู
6. **ุงูุณุนุฑ ูุธูุฑ ุชููุงุฆูุงู**: 10 ุฏ.ู
7. ููููู ุชุบููุฑ ุงููุฒูุฏ ุฅูู "ุฏุฑุจ ุงูุณุจูู"
8. ุงูุณุนุฑ ูุจูู 10 ุฏ.ู (ููุณ ุงูุณุนุฑ)

**ุงููุชูุฌุฉ**:
```json
{
  "userId": "...",
  "cityId": "ุจูุบุงุฒู",
  "area": "ุจูุบุงุฒู",
  "deliveryCompanyId": "darb",
  "shippingCost": 10  // โ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
}
```

---

### โ ุงูุณููุงุฑูู 3: ูุณุชุฎุฏู ูุฏูู ูุบูุฑ ุงููุฏููุฉ

**ุงูุฎุทูุงุช**:
1. ูุณุชุฎุฏู ูุฏูู ุญุณุงุจ ูุฏูู
2. ุงููุฏููุฉ ุงููุญููุธุฉ: "ูุตุฑุงุชุฉ"
3. ุงูููุทูุฉ ุงููุญููุธุฉ: "ูุตุฑุงุชุฉ"
4. ูุฐูุจ ูู Checkout
5. **ุงูุณุนุฑ ุงูุงูุชุฑุงุถู**: 20 ุฏ.ู (Vanex)
6. ูุถุบุท "ุชุนุฏูู" ุงูุนููุงู
7. ูุฎุชุงุฑ ุงููุฒูุฏ: "ุฏุฑุจ ุงูุณุจูู"
8. ูุฎุชุงุฑ ุงููุฏููุฉ: "ุณุจูุง"  
9. ูุฎุชุงุฑ ุงูููุทูุฉ: "ูุฑุฒู"
10. **ุงูุณุนุฑ ูุชุญุฏุซ ุฅูู**: 60 ุฏ.ู

**ุงููุชูุฌุฉ**:
```json
{
  "userId": "...",
  "cityId": "ุณุจูุง",
  "area": "ูุฑุฒู",
  "deliveryCompanyId": "darb",
  "shippingCost": 60  // โ ุฃุนูู ุณุนุฑ (ููุทูุฉ ูุงุฆูุฉ)
}
```

---

## ๐จ ุนุฑุถ ุงูุณุนุฑ ูู ุงููุงุฌูุฉ

### ูููุณุชุฎุฏููู ุงููุณุฌููู:
```typescript
// ุงูุณุทูุฑ 528-532 ูู Checkout.tsx
{shippingPrice > 0 && (
  <p className="font-bold text-primary text-lg mt-2">
    ุณุนุฑ ุงูุชูุตูู: {shippingPrice} ุฏ.ู  {/* โ ูุธูุฑ ุจูุถูุญ */}
  </p>
)}
```

### ููุถููู/ุนูุฏ ุงูุชุนุฏูู:
ุงูุณุนุฑ ููุญุฏุซ ุชููุงุฆูุงู ุนูุฏ:
1. ุงุฎุชูุงุฑ ูุฏููุฉ
2. ุงุฎุชูุงุฑ ููุทูุฉ
3. ุชุบููุฑ ูุฒูุฏ ุงูุดุญู

---

## ๐ฑ ููุฎุต ุงูุฅุฌุฑุงุกุงุช

### ุนูุฏ ุงุฎุชูุงุฑ Darb Sabil:

| ุงูุฅุฌุฑุงุก | ูุงุฐุง ูุญุฏุซ | ุงูุณุนุฑ |
|---------|-----------|-------|
| **ุงุฎุชูุงุฑ ุงููุฒูุฏ** | `providerId = "darb"` | - |
| **ุฌูุจ ุงููุฏู** | `trpc.delivery.cities({ providerId: "darb" })` | - |
| **ุงุฎุชูุงุฑ ูุฏููุฉ** | `setShippingPrice(city.darbPrice)` | โ ูุธูุฑ |
| **ุงุฎุชูุงุฑ ููุทูุฉ** | `setShippingPrice(region.darbPrice)` | โ ูุชุญุฏุซ |
| **ุชุฃููุฏ ุงูุทูุจ** | `createOrder({ deliveryCompanyId: "darb", ... })` | โ ููุญูุธ |

---

## ๐ ุงูุชุญูู ูู ุงูููุฏ

### Frontend (Checkout.tsx):

โ ุงูุณุทุฑ 115: ุชุญุฏูุฏ ุงููุฒูุฏ ุงูุงูุชุฑุงุถู (`'darb'`)  
โ ุงูุณุทุฑ 117: ุฌูุจ ุงููุฏู ุญุณุจ ุงููุฒูุฏ  
โ ุงูุณุทูุฑ 132-141: ุชุญุฏูุซ ุงูุณุนุฑ ุนูุฏ ุงุฎุชูุงุฑ ููุทูุฉ  
โ ุงูุณุทูุฑ 183-191: ุชุญุฏูุซ ุงูุณุนุฑ ุนูุฏ ุชุบููุฑ ุงููุฒูุฏ  
โ ุงูุณุทูุฑ 193-200: ุชุญุฏูุซ ุงูุณุนุฑ ุนูุฏ ุงุฎุชูุงุฑ ูุฏููุฉ  
โ ุงูุณุทุฑ 257: ุฅุฑุณุงู `deliveryCompanyId` ููู Backend  

### Backend (routers.ts):

โ ุงูุณุทูุฑ 579-614: ุญุณุงุจ `shippingCost` ุจุฏูุฉ  
โ ุงูุณุทุฑ 597: ุงุฎุชูุงุฑ ุงูุณุนุฑ ุญุณุจ ุงููุฒูุฏ (`darb` ุฃู `vanex`)  
โ ุงูุณุทูุฑ 600-611: ุชุฌุงูุฒ ุจุณุนุฑ ุงูููุทูุฉ  
โ ุงูุณุทุฑ 694: ุญูุธ `shippingCost` ูู ุงูุทูุจ  

---

## โ ุงูุฎูุงุตุฉ

### ุงูุฃุณุนุงุฑ ูุทุจูุฉ ุจุงููุงูู ูู:

1. **โ ุงูุถููู (Guests)**:
   - ูููุคูู ุงูุจูุงูุงุช ูุฏููุงู
   - ูุฎุชุงุฑูู ุงููุฏููุฉ ูุงูููุทูุฉ
   - **ุงูุณุนุฑ ููุญุณุจ ูููุนุฑุถ ููุฑุงู**

2. **โ ุงููุณุชุฎุฏููู ุงูุฌุฏุฏ**:
   - ุงูุจูุงูุงุช ููููุกุฉ ูู ุงูููู ุงูุดุฎุตู
   - ูููููู ุงูุชุนุฏูู
   - **ุงูุณุนุฑ ููุญุณุจ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช**

3. **โ ุงููุณุชุฎุฏููู ุงููุฏุงูู**:
   - ุงูุจูุงูุงุช ุงููุญููุธุฉ ุชูุณุชุฎุฏู
   - ูููููู ุงูุชุนุฏูู ุฃู ุชุบููุฑ ุงููุฒูุฏ
   - **ุงูุณุนุฑ ูุชุญุฏุซ ุชููุงุฆูุงู**

---

## ๐ ุฃูุซูุฉ ุงูุฃุณุนุงุฑ ุงููุทุจูุฉ

| ุงููุฏููุฉ | ุงูููุทูุฉ | Darb Sabil | Vanex |
|---------|---------|------------|-------|
| ุทุฑุงุจูุณ | ุงููุฏููุฉ | 10 ุฏ.ู | 15 ุฏ.ู |
| ุทุฑุงุจูุณ | ุงููุฌููุฉ | 20 ุฏ.ู | 25 ุฏ.ู |
| ุจูุบุงุฒู | ุจูุบุงุฒู | 10 ุฏ.ู | 12 ุฏ.ู |
| ุจูุบุงุฒู | ุชูุชูุฑุฉ | 35 ุฏ.ู | 40 ุฏ.ู |
| ูุตุฑุงุชุฉ | ูุตุฑุงุชุฉ | 20 ุฏ.ู | 22 ุฏ.ู |
| ุณุจูุง | ุณุจูุง | 35 ุฏ.ู | 40 ุฏ.ู |
| ุณุจูุง | ูุฑุฒู | 60 ุฏ.ู | 70 ุฏ.ู |

---

## ๐ฏ ูุง ุญุงุฌุฉ ูุฃู ุชุนุฏูู!

**ุงููุธุงู ูุนูู ุจุดูู ูุซุงูู**:
- โ ุงูุฃุณุนุงุฑ ูุญุณูุจุฉ ุจุฏูุฉ
- โ ุชูุนุฑุถ ูููุณุชุฎุฏู ูุจู ุงูุชุฃููุฏ
- โ ุชูุญูุธ ูู ุงูุทูุจ
- โ ุชุนูู ูุฌููุน ุฃููุงุน ุงููุณุชุฎุฏููู

---

**ุชุงุฑูุฎ ุงูุชุญูู**: 2026-01-10  
**ุงูุญุงูุฉ**: โ ูุนูู ุจููุงุกุฉ ูุงููุฉ
